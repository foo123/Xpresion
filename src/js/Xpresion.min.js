/**
*
*   Xpresion
*   Simple eXpression parser engine with variables and custom functions support for PHP, Python, Node/JS, ActionScript
*   @version: 0.5
*
*   https://github.com/foo123/Xpresion
*
**/
!function(t,n,e){"use strict";var r,i="object"==typeof module&&module.exports,l="function"==typeof define&&define.amd;i?module.exports=(module.$deps=module.$deps||{})[n]=module.$deps[n]||e.call(t,{NODE:module})||1:l&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(n)?define(n,["require","exports","module"],function(n,r,i){return e.call(t,{AMD:i})}):n in t||(t[n]=r=e.call(t,{})||1)&&l&&define(n,[],function(){return r})}(this,"Xpresion",function(t,n){"use strict";var e,r,i,l,u,o,s,a="0.5",c="prototype",p="hasOwnProperty",h=JSON.stringify,f=Object.keys,_=Object.create,d=function(t,n){return new Function(t,n)},y=function(t,n){return new RegExp(t,n||"")},v=/\n\r|\r\n|\n|\r/g,g=/'/g,$=function(){return null},m="BLOCKS",R="OPERATORS",O="FUNCTIONS",b=!1;s=function q(t){var n=this;return n instanceof q?(n.source=t||"",n.setup(),void q.parse(n)):new q(t)},s.VERSION=a;var E=(s.COMMA=",",s.LPAREN="(",s.RPAREN=")",s.NONE=0),T=s.DEFAULT=1,P=s.LEFT=-2,x=s.RIGHT=2,S=s.PREFIX=2,F=s.INFIX=4,A=s.POSTFIX=8,N=s.T_DUM=0,D=s.T_DFT=1,I=s.T_IDE=16,j=s.T_VAR=17,C=s.T_LIT=32,w=s.T_NUM=33,M=s.T_STR=34,k=s.T_REX=35,z=s.T_BOL=36,V=(s.T_DTM=37,s.T_ARY=38),L=s.T_OP=128,X=s.T_N_OP=129,K=s.T_POLY_OP=130,U=s.T_FUN=131;return s.Tpl=e=function Y(t,n,e){var r=this;return r instanceof Y?(r.id=null,r._renderer=null,r.tpl=Y.multisplit(t||"",n||Y.defaultArgs),!0===e&&(r._renderer=Y.compile(r.tpl)),void r.fixRenderer()):new Y(t,n,e)},e.defaultArgs={"$-5":-5,"$-4":-4,"$-3":-3,"$-2":-2,"$-1":-1,$0:0,$1:1,$2:2,$3:3,$4:4,$5:5},e.multisplit=function(t,n,e){var r,i,l,u,o,s,a,c,p,h;e=!!e,s=[[1,t]];for(r in n)if(n.hasOwnProperty(r)){for(c=[],i=e?n[r]:r,l=[0,n[r]],u=0,p=s.length;p>u;u++)if(1===s[u][0]){if(a=s[u][1].split(i),h=a.length,c.push([1,a[0]]),h>1)for(o=0;h-1>o;o++)c.push(l),c.push([1,a[o+1]])}else c.push(s[u]);s=c}return s},e.arg=function(t,n){var e,r,i,l,u,o="args";if(arguments.length&&null!=t)for(t=t.substr?t.length?t.split("."):[]:[t],l=t.length,u=!(!n||!n.substr),e=0;l>e;e++)r=t[e],i=+r,isNaN(i)?o+='["'+r+'"]':(0>i&&(r=u?n+-i:o+".length-"+-i),o+="["+r+"]");return o},e.compile=function(t,n){var r,i,l,u,o=t.length;if(!0===n){for(u='"use strict"; return (',r=0;o>r;r++)i=t[r][0],l=t[r][1],u+=i?l:e.arg(l);u+=");"}else{for(u='"use strict"; var argslen=args.length; return (',r=0;o>r;r++)i=t[r][0],l=t[r][1],u+=i?"'"+l.replace(g,"\\'").replace(v,"' + \"\\n\" + '")+"'":" + String("+e.arg(l,"argslen")+") + ";u+=");"}return d("args",u)},e[c]={constructor:e,id:null,tpl:null,_renderer:null,dispose:function(){return this.id=null,this.tpl=null,this._renderer=null,this},fixRenderer:function(){return this.render="function"==typeof this._renderer?this._renderer:this.constructor[c].render,this},render:function(t){t=t||[];var n,e,r,i=this.tpl,l=i.length,u=t.length,o="";for(n=0;l>n;n++)e=i[n][0],r=i[n][1],o+=e?r:!r.substr&&0>r?t[u+r]:t[r];return o}},s.Alias=i=function B(t){return this instanceof B?void(this.alias=t):new B(t)},i.get_entry=function(t,n){if(n&&t&&t[p](n)){for(var e=t[n];e instanceof i&&t[p](e.alias);)n=e.alias,e=t[n];return e}return!1},s.Node=r=function Z(t,n,e,r){var i=this;return i instanceof Z?(i.type=t,i.node=n,i.children=e||null,void(i.pos=r||0)):new Z(t,n,e,r)},r[c]={constructor:r,type:null,node:null,children:null,pos:null,op_parts:null,op_index:null,op_next:function(t){var n=this,e=0===n.op_parts.indexOf(t.input);return e&&n.op_parts.shift(),e},op_complete:function(){return!this.op_parts.length},dispose:function(){var t,n,e=this,r=e.children;if(r&&(t=r.length))for(n=0;t>n;n++)r[n]&&r[n].dispose();return e.type=null,e.pos=null,e.node=null,e.op_parts=null,e.op_index=null,r=e.children=null,e},toString:function(){var t,n=[],e=this.node,r=this.children?this.children:[],i=r.length,l=arguments.length&&arguments[0].substr?arguments[0]:"",u=l+"  ";for(t=0;i>t;t++)n.push(r[t].toString(u));return l+["Node("+e.type+"): "+(e.parts?e.parts.join(" "):e.input),"Childs: [",l+n.join("\n"+l),"]"].join("\n"+l)+"\n"}},r.DFT=function(t,n,e){e=!1!==e,n=n||s.render;for(var r,i,l,u=[t],o=[];u.length;)r=u[0],r.children&&r.children.length?(u=r.children.concat(u),r.children=null):(u.shift(),i=r.node,l=n(i,i.arity?o.splice(o.length-i.arity,i.arity):[]),o.push(l),e&&r.dispose());return u=null,o[0]},s.reduce=function(t,n,e,i,l){var u,o,s,a,c,p=null,h=0;if(i)if(a=i,K===a.type&&(a=a.morph([l,t,n])),X===a.type)s=a.node(null,l,n.length+1),e.unshift(s),n.unshift(s);else{if(e.length&&(p=e[0],h=p.op_index),p&&p.op_next(a)){for(;n.length>h;)u=n.shift(),o=u.node,s=o.node(t.splice(t.length-o.arity,o.arity),u.pos),t.push(s);if(!p.op_complete())return;e.shift(),n.shift(),a=p.node,p.dispose(),h=e.length?e[0].op_index:0}if(c=a.fixity,A===c)s=a.node(t.splice(t.length-a.arity,a.arity),l),t.push(s);else if(S===c)n.unshift(r(a.otype,a,null,l));else{for(;n.length>h;){if(u=n.shift(),o=u.node,!(o.priority<a.priority||o.priority===a.priority&&(o.associativity<a.associativity||o.associativity===a.associativity&&o.associativity<0))){n.unshift(u);break}s=o.node(t.splice(t.length-o.arity,o.arity),u.pos),t.push(s)}n.unshift(r(a.otype,a,null,l))}}else for(;n.length;)u=n.shift(),o=u.node,s=o.node(t.splice(t.length-o.arity,o.arity),u.pos),t.push(s)},s.parse_delimited_block=function(t,n,e,r,i){var l=r,u=!1,o="";for(i=!1!==i,n+=1;e>n&&(o=t.charAt(n++),l+=o,r!==o||u);)u=i?!u&&"\\"===o:!1;return l},s.parse=function(t){var n,e,r,l,u,o,a,c,h,_,d,y,v,g,$,R,O=t,b=s.reduce,E=i.get_entry,T=O.RE,P=O[m],x=!T[p]("t_var"),S=0;for(n=O.source,e=n.length,O._cnt=0,O._symbol_table={},O._cache={},O.variables={},h=[],_=[],d=[],y=0,o=0;e>o;)if(l=n.charAt(o),(v=E(P,l))&&(u=v.parse(n,o,e,l),!1!==u&&(o+=u.length,g=v[p]("rest")?v.rest(n,o,e)||"":"",o+=g.length,c=O.t_block(u,v.type,g),!1!==c)))y+=1,h.push(c.node(null,y));else if(r=n.slice(o),a=r.match(T.t_spc))o+=a[0].length;else if((a=r.match(T.t_num))&&(c=O.t_liter(a[1],w),!1!==c))y+=1,h.push(c.node(null,y)),o+=a[0].length;else{if(a=r.match(T.t_ident)){if(c=O.t_liter(a[1],I),!1!==c){y+=1,h.push(c.node(null,y)),o+=a[0].length;continue}if(c=O.t_op(a[1]),!1!==c){y+=1,b(h,_,d,c,y),o+=a[0].length;continue}if(x&&(c=O.t_var(a[1]),!1!==c)){y+=1,h.push(c.node(null,y)),o+=a[0].length;continue}}if(a=r.match(T.t_special)){for(u=a[1],c=!1;u.length>0&&(c=O.t_op(u),!1===c);)u=u.slice(0,-1);if(!1!==c){y+=1,b(h,_,d,c,y),o+=u.length;continue}}if(x||!(a=r.match(T.t_var))||(c=O.t_var(a[1]),!1===c)){if(a=r.match(T.t_nonspc)){if(c=O.t_liter(a[1],C),!1!==c){y+=1,h.push(c.node(null,y)),o+=a[0].length;continue}if(c=O.t_op(a[1]),!1!==c){y+=1,b(h,_,d,c,y),o+=a[0].length;continue}c=O.t_tok(a[1]),y+=1,h.push(c.node(null,y)),o+=a[0].length}}else y+=1,h.push(c.node(null,y)),o+=a[0].length}if(S=0,b(h,_,d),(1!==h.length||_.length>0)&&(S=1,R="Parse Error, Mismatched Parentheses or Operators"),!S)try{$=O.compile(h[0])}catch(r){S=1,R="Compilation Error, "+r.message}return d=null,_=null,h=null,O._symbol_table=null,S?($=null,O.variables=[],O._cnt=0,O._cache={},O._evaluator_str="",O._evaluator=O.dummy_evaluator,console.error("Xpresion Error: "+R+" at "+n)):(O.variables=f(O.variables),O._evaluator_str=$[0],O._evaluator=$[1]),O},s.render=function(t,n){return t.render(n)},s.defRE=function(t,n){if("object"==typeof t){n=n||s.RE;for(var e in t)t[p](e)&&(n[e]=t[e])}return n},s.defBlock=function(t,n){if("object"==typeof t){n=n||s[m];for(var e in t)t[p](e)&&(n[e]=t[e])}return n},s.defReserved=function(t,n){if("object"==typeof t){n=n||s.Reserved;for(var e in t)t[p](e)&&(n[e]=t[e])}return n},s.defOp=function(t,n){if("object"==typeof t){n=n||s[R];for(var e in t)t[p](e)&&(n[e]=t[e])}return n},s.defFunc=function(t,n){if("object"==typeof t){n=n||s[O];for(var e in t)t[p](e)&&(n[e]=t[e])}return n},s.defRuntimeFunc=function(t,n){if("object"==typeof t){n=n||s.Fn;for(var e in t)t[p](e)&&(n[e]=t[e])}return n},s.Tok=l=function G(t,n,e,r){var i=this;return i instanceof G?(i.type=t,i.input=n,i.output=e,i.value=r||null,i.priority=1e3,i.parity=0,i.arity=0,i.associativity=T,i.fixity=F,i.parenthesize=!1,void(i.revert=!1)):new G(t,n,e,r)},l.render=function(t){return t instanceof l?t.render():String(t)},l[c]={constructor:l,type:null,input:null,output:null,value:null,priority:1e3,parity:0,arity:0,associativity:T,fixity:F,parenthesize:!1,revert:!1,dispose:function(){var t=this;return t.type=null,t.input=null,t.output=null,t.value=null,t.priority=null,t.parity=null,t.arity=null,t.associativity=null,t.fixity=null,t.parenthesize=null,t.revert=null,t},setType:function(t){return this.type=t,this},setParenthesize:function(t){return this.parenthesize=!!t,this},setReverse:function(t){return this.revert=!!t,this},render:function(t){var n,r=this,i=r.output,l=r.parenthesize,u=l?s.LPAREN:"",o=l?s.RPAREN:"";return t||(t=[]),t.unshift(r.input),n=i instanceof e?i.render(t):i,u+n+o},node:function(t,n){return r(this.type,this,t?t:null,n)},toString:function(){return String(this.output)}},s.Op=u=function H(t,r,i,u,o,s,a,c){var p=this;return p instanceof H?(t=t||"",s=s||"",p.parts=[].concat(t),p.type=t&&t.push&&t.pop?X:L,!s||s instanceof e||(s=e(s)),l.call(p,p.type,p.parts[0],s),p.fixity=r||S,p.associativity=i||T,p.priority=u||1e3,p.arity=o||0,p.otype=n!==a?a:D,p.ofixity=n!==c?c:p.fixity,p.parenthesize=!1,p.revert=!1,void(p.morphes=null)):new H(t,r,i,u,o,s,a,c)},u.Condition=function(t){return["function"==typeof t[0]?t[0]:e.compile(e.multisplit(t[0],{"${POS}":0,"${TOKS}":1,"${OPS}":2,"${TOK}":3,"${OP}":4,"${PREV_IS_OP}":5,"${DEDUCED_TYPE}":6,Xpresion:7}),!0),t[1]]},u[c]=_(l[c]),u[c].otype=null,u[c].ofixity=null,u[c].parts=null,u[c].morphes=null,u[c].dispose=function(){var t=this;return l[c].dispose.call(t),t.otype=null,t.ofixity=null,t.parts=null,t.morphes=null,t},u[c].Polymorphic=function(t){var n=this;return n.type=K,n.morphes=(t||[]).map(u.Condition),n},u[c].morph=function(t){var n,e=this.morphes,r=e.length,i=0,l=e[0][1],u=!1;for(t.length<8&&(t.push(t[1].length?t[1][t[1].length-1]:!1),t.push(t[2].length?t[2][0]:!1),t.push(t[4]?t[4].pos+1===t[0]:!1),t.push(t[4]?t[4].type:t[3]?t[3].type:0),t.push(s));r>i;){if(n=e[i++],!0===Boolean(n[0](t))){n=n[1],u=!0;break}n[1].priority>=l.priority&&(l=n[1])}for(u||(n=l);K===n.type;)n=n.morph(t);return n},u[c].render=function(t){t&&t.length||(t=["",""]);{var n,r=this,i=r.otype,u=r.output,o=r.parenthesize,a=o?s.LPAREN:"",c=o?s.RPAREN:"",p=s.COMMA,h=r.ofixity;t.length}return n=u instanceof e?a+u.render(t)+c:F===h?a+t.join(u)+c:A===h?a+t.join(p)+c+u:u+a+t.join(p)+c,l(i,n,n)},u[c].node=function(t,n){t=t||[];var e,i=this,l=i.otype;return i.revert&&t.reverse(),N===l&&t.length?l=t[0].type:t.length&&(t[0].type=l),e=r(l,i,t,n),X===i.type&&arguments.length>2&&(e.op_parts=i.parts.slice(1),e.op_index=arguments[2]),e},s.Func=o=function J(t,n,e,r,i,l){var o=this;return o instanceof J?(u.call(o,t,S,i||x,r||5,1,n,e,l||S),void(o.type=U)):new J(t,n,e,r,i,l)},o[c]=_(u[c]),s[c]={constructor:s,source:null,variables:null,RE:null,Reserved:null,BLOCKS:null,OPERATORS:null,FUNCTIONS:null,Fn:null,_cnt:0,_cache:null,_symbol_table:null,_evaluator_str:null,_evaluator:null,dummy_evaluator:null,dispose:function(){var t=this;return t.RE=null,t.Reserved=null,t[m]=null,t[R]=null,t[O]=null,t.Fn=null,t.dummy_evaluator=null,t.source=null,t.variables=null,t._cnt=null,t._symbol_table=null,t._cache=null,t._evaluator_str=null,t._evaluator=null,t},setup:function(){var t=this;return t.RE=s.RE,t.Reserved=s.Reserved,t[m]=s[m],t[R]=s[R],t[O]=s[O],t.Fn=s.Fn,t.dummy_evaluator=$,t},compile:function(t){var n=r.DFT(t,s.render,!0);return[n,d("Var,Fn,Cache",'"use strict"; return '+n+";")]},evaluator:function(t){return arguments.length?(t&&t.call&&(this._evaluator=t),this):this._evaluator},evaluate:function(t,n){return 1>arguments.length&&(t={}),2>arguments.length&&(n=this.Fn),this._evaluator(t,n,this._cache)},debug:function(t){var n=this,e=["Expression: "+n.source,"Variables : ["+n.variables.join(",")+"]","Evaluator : "+n._evaluator_str];return arguments.length&&(e.push("Data      : "+h(t,null,4)),e.push("Result    : "+h(n.evaluate(t)))),e.join("\n")},toString:function(){return"[Xpresion source]: "+this.source},t_liter:function(t,n){return w===n?l(w,t,t):i.get_entry(this.Reserved,t.toLowerCase())},t_block:function(t,n,e){if(M===n)return l(M,t,t);if(k===n){e=e||"";var r,i,u="re_"+t+e;return this._symbol_table[p](u)?r=this._symbol_table[u]:(r="re_"+ ++this._cnt,i=t.slice(1,-1),this._cache[r]=y(i,e),this._symbol_table[u]=r),l(k,t,"Cache."+r)}return!1},t_var:function(t){return this.variables[p](t)||(this.variables[t]=t),l(j,t,'Var["'+t.split(".").join('"]["')+'"]')},t_op:function(t){var n=!1;return n=i.get_entry(this[O],t),!1===n&&(n=i.get_entry(this[R],t)),n},t_tok:function(t){return l(D,t,t)}},s.init=function(){b||(s[R]={"(":u(["(",")"],A,x,1,1,"$0",N),")":u(")"),"[":u(["[","]"],A,x,2,1,"[$0]",V),"]":u("]"),",":u(",",F,P,3,2,"$0,$1",D),"?":u(["?",":"],F,x,100,3,"($0?$1:$2)",z),":":u(":"),"!":u("!",S,x,10,1,"!$0",z),"~":u("~",S,x,10,1,"~$0",w),"^":u("^",F,x,11,2,"Math.pow($0,$1)",w),"*":u("*",F,P,20,2,"($0*$1)",w),"/":u("/",F,P,20,2,"($0/$1)",w),"%":u("%",F,P,20,2,"($0%$1)",w),"+":u().Polymorphic([["${TOK} && !${PREV_IS_OP} && (${DEDUCED_TYPE}===Xpresion.T_ARY)",u("+",F,P,25,2,"Fn.ary_merge($0,$1)",V)],["${TOK} && !${PREV_IS_OP} && (${DEDUCED_TYPE}===Xpresion.T_STR)",u("+",F,P,25,2,"($0+String($1))",M)],["${TOK} && !${PREV_IS_OP}",u("+",F,P,25,2,"($0+$1)",w)],["!${TOK} || ${PREV_IS_OP}",u("+",S,x,4,1,"$0",w)]]),"-":u().Polymorphic([["${TOK} && !${PREV_IS_OP}",u("-",F,P,25,2,"($0-$1)",w)],["!${TOK} || ${PREV_IS_OP}",u("-",S,x,4,1,"(-$0)",w)]]),">>":u(">>",F,P,30,2,"($0>>$1)",w),"<<":u("<<",F,P,30,2,"($0<<$1)",w),">":u(">",F,P,35,2,"($0>$1)",z),"<":u("<",F,P,35,2,"($0<$1)",z),">=":u(">=",F,P,35,2,"($0>=$1)",z),"<=":u("<=",F,P,35,2,"($0<=$1)",z),"==":u().Polymorphic([["${DEDUCED_TYPE}===Xpresion.T_ARY",u("==",F,P,40,2,"Fn.ary_eq($0,$1)",z)],["true",u("==",F,P,40,2,"($0==$1)",z)]]),"!=":u("!=",F,P,40,2,"($0!=$1)",z),matches:u("matches",F,E,40,2,"$0.test($1)",z),"in":u("in",F,E,40,2,"(-1<$1.indexOf($0))",z),has:u("has",F,E,40,2,"(-1<$0.indexOf($1))",z),"&":u("&",F,P,45,2,"($0&$1)",w),"|":u("|",F,P,46,2,"($0|$1)",w),"&&":u("&&",F,P,47,2,"($0&&$1)",z),"||":u("||",F,P,48,2,"($0||$1)",z),or:i("||"),and:i("&&"),not:i("!")},s[O]={min:o("min","Math.min($0)",w),max:o("max","Math.max($0)",w),pow:o("pow","Math.pow($0)",w),sqrt:o("sqrt","Math.sqrt($0)",w),len:o("len","Fn.len($0)",w),"int":o("int","parseInt($0)",w),str:o("str","String($0)",M),clamp:o("clamp","Fn.clamp($0)",w),sum:o("sum","Fn.sum($0)",w),avg:o("avg","Fn.avg($0)",w)},s.Fn={clamp:function(t,n,e){return n>e?t>n?n:e>t?e:t:t>e?e:n>t?n:t},len:function(t){return t?t.substr||t.push?t.length:Object===t.constructor?f(t).length:1:0},sum:function(){var t,n,e=arguments,r=0;if(e[0]&&Array===e[0].constructor&&(e=e[0]),n=e.length,n>0)for(t=0;n>t;t++)r+=e[t];return r},avg:function(){var t,n,e=arguments,r=0;if(e[0]&&Array===e[0].constructor&&(e=e[0]),n=e.length,n>0){for(t=0;n>t;t++)r+=e[t];r/=n}return r},ary_eq:function(t,n){var e,r=t.length;if(r!==n.length)return!1;for(e=0;r>e;e++)if(t[e]!=n[e])return!1;return!0},ary_merge:function(t,n){return[].concat(t,n)},match:function(t,n){return n.test(t)},contains:function(t,n){return-1<t.indexOf(n)}},s.RE={t_spc:/^(\s+)/,t_nonspc:/^(\S+)/,t_special:/^([*.\-+\\\/\^\$\(\)\[\]|?<:>&~%!#@=_,;{}]+)/,t_num:/^(\d+(\.\d+)?)/,t_ident:/^([a-zA-Z_][a-zA-Z0-9_]*)\b/,t_var:/^\$([a-zA-Z0-9_][a-zA-Z0-9_.]*)\b/},s[m]={"'":{type:M,parse:s.parse_delimited_block},'"':i("'"),"`":{type:k,parse:s.parse_delimited_block,rest:function(t,n,e){for(var r,i="",l=!1,u=!1,o=0,s=n+o,a=!0;e>s&&a;)r=t.charAt(s++),o+=1,"i"!==r||l||(i+="i",l=!0),"g"!==r||u||(i+="g",u=!0),(o>=2||!l&&!u)&&(a=!1);return i}}},s.Reserved={"null":l(I,"null","null"),"false":l(z,"false","false"),"true":l(z,"true","true"),infinity:l(w,"Infinity","Infinity"),nan:l(w,"NaN","NaN"),none:i("null"),inf:i("inf")},b=!0)},s.init(),s});
/**
*
*   Xpresion
*   Simple eXpression parser engine with variables and custom functions support for PHP, Python, Node/JS, ActionScript
*   @version: 0.5-alpha
*
*   https://github.com/foo123/Xpresion
*
**/
!function(t,n,e){"use strict";var r,i="object"==typeof module&&module.exports,u="function"==typeof define&&define.amd;i?module.exports=(module.$deps=module.$deps||{})[n]=module.$deps[n]||e.call(t,{NODE:module})||1:u&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(n)?define(n,["require","exports","module"],function(n,r,i){return e.call(t,{AMD:i})}):n in t||(t[n]=r=e.call(t,{})||1)&&u&&define(n,[],function(){return r})}(this,"Xpresion",function(t,n){"use strict";var e,r,i,u,l,o,s,a,c="0.5-alpha",f="prototype",h="hasOwnProperty",p=JSON.stringify,_=Object.keys,d=Object.create,v=function(t,n){return new Function(t,n)},y=function(t,n){return new RegExp(t,n||"")},$=function(t){return new Date(t)},g=/\n\r|\r\n|\n|\r/g,m=/'/g,R=function(){return null},b="BLOCKS",O="OPERATORS",T="FUNCTIONS",E=!1;a=function Z(t){var n=this;return n instanceof Z?(n.source=t||"",void n.setup().parse()):new Z(t)},a.VERSION=c;var P=(a.COMMA=",",a.LPAREN="(",a.RPAREN=")",a.NONE=0),S=a.DEFAULT=1,F=a.LEFT=-2,N=a.RIGHT=2,A=a.PREFIX=2,x=a.INFIX=4,I=a.POSTFIX=8,j=a.T_DUM=0,w=a.T_DFT=1,C=a.T_IDE=16,k=a.T_VAR=17,M=a.T_LIT=32,V=a.T_NUM=33,z=a.T_STR=34,D=a.T_REX=35,L=a.T_BOL=36,X=a.T_DTM=37,K=a.T_ARY=38,U=a.T_OP=128,q=a.T_N_OP=129,Y=a.T_POLY_OP=130,B=a.T_FUN=131;return a.Tpl=e=function G(t,n,e){var r=this;return r instanceof G?(r.id=null,r._renderer=null,r.tpl=G.multisplit(t||"",n||G.defaultArgs),!0===e&&(r._renderer=G.compile(r.tpl)),void r.fixRenderer()):new G(t,n,e)},e.defaultArgs={"$-4":-4,"$-3":-3,"$-2":-2,"$-1":-1,$0:0,$1:1,$2:2,$3:3,$4:4},e.multisplit=function(t,n,e){var r,i,u,l,o,s,a,c,f,h;e=!!e,s=[[1,t]];for(r in n)if(n.hasOwnProperty(r)){for(c=[],i=e?n[r]:r,u=[0,n[r]],l=0,f=s.length;f>l;l++)if(1===s[l][0]){if(a=s[l][1].split(i),h=a.length,c.push([1,a[0]]),h>1)for(o=0;h-1>o;o++)c.push(u),c.push([1,a[o+1]])}else c.push(s[l]);s=c}return s},e.arg=function(t,n){var e,r,i,u,l,o="args";if(arguments.length&&null!=t)for(t=t.substr?t.length?t.split("."):[]:[t],u=t.length,l=!(!n||!n.substr),e=0;u>e;e++)r=t[e],i=+r,isNaN(i)?o+='["'+r+'"]':(0>i&&(r=l?n+-i:o+".length-"+-i),o+="["+r+"]");return o},e.compile=function(t,n){var r,i,u,l,o=t.length;if(!0===n){for(l='"use strict"; return (',r=0;o>r;r++)i=t[r][0],u=t[r][1],l+=i?u:e.arg(u);l+=");"}else{for(l='"use strict"; var argslen=args.length; return (',r=0;o>r;r++)i=t[r][0],u=t[r][1],l+=i?"'"+u.replace(m,"\\'").replace(g,"' + \"\\n\" + '")+"'":" + String("+e.arg(u,"argslen")+") + ";l+=");"}return v("args",l)},e[f]={constructor:e,id:null,tpl:null,_renderer:null,dispose:function(){return this.id=null,this.tpl=null,this._renderer=null,this},fixRenderer:function(){return this.render="function"==typeof this._renderer?this._renderer:this.constructor[f].render,this},render:function(t){t=t||[];var n,e,r,i=this.tpl,u=i.length,l=t.length,o="";for(n=0;u>n;n++)e=i[n][0],r=i[n][1],o+=e?r:!r.substr&&0>r?t[l+r]:t[r];return o}},a.Node=r=function H(t,n,e,r){var i=this;return i instanceof H?(i.type=t,i.node=n,i.children=e||null,void(i.pos=r||0)):new H(t,n,e,r)},r[f]={constructor:r,type:null,node:null,children:null,pos:null,dispose:function(){var t,n,e=this,r=e.children;if(r&&(t=r.length))for(n=0;t>n;n++)r[n]&&r[n].dispose();return e.type=null,e.pos=null,e.node=null,r=e.children=null,e},toString:function(){var t,n=[],e=this.node,r=this.children?this.children:[],i=r.length,u=arguments.length&&arguments[0].substr?arguments[0]:"",l=u+"  ";for(t=0;i>t;t++)n.push(r[t].toString(l));return u+["Node("+e.type+"): "+(e.parts?e.parts.join(" "):e.input),"Childs: [",u+n.join("\n"+u),"]"].join("\n"+u)+"\n"}},r.DFT=function(t,n,e){e=!1!==e,n=n||a.render_action;for(var r,i,u=[t],l=[];u.length;)r=u[0],r.children&&r.children.length?(u=r.children.concat(u),r.children=null):(u.shift(),i=r.node,l.push(n(i,i.arity?l.splice(l.length-i.arity,i.arity):[])),e&&r.dispose());return u=null,l[0]},a.render_action=function(t,n){return t.render(n)},a.reduce=function(t,n,e,i,u){var l,o,s,a,c,f=null,h=0;if(i)if(a=i,Y===a.type&&(a=a.morph([u,t,n])),q===a.type)s=a.node(null,u,n.length+1),e.unshift(s),n.unshift(s);else{if(e.length&&(f=e[0],h=f.op_index),f&&f.next(a)){for(;n.length>h;)l=n.shift(),o=l.node,s=o.node(t.splice(0,o.arity).reverse(),l.pos),t.unshift(s);if(!f.complete())return;e.shift(),n.shift(),a=f.node,h=e.length?e[0].op_index:0}if(c=a.fixity,I===c)s=a.node(t.splice(0,a.arity).reverse(),u),t.unshift(s);else if(A===c)n.unshift(r(a.o_type,a,null,u));else{for(;n.length>h;){if(l=n.shift(),o=l.node,!(o.priority<a.priority||o.priority===a.priority&&(o.associativity<a.associativity||o.associativity===a.associativity&&o.associativity<0))){n.unshift(l);break}s=o.node(t.splice(0,o.arity).reverse(),l.pos),t.unshift(s)}n.unshift(r(a.o_type,a,null,u))}}else for(;n.length;)l=n.shift(),o=l.node,s=o.node(t.splice(0,o.arity).reverse(),l.pos),t.unshift(s)},a.parse_delimited_block=function(t,n,e,r,i){var u=r,l=!1,o="";for(i=!!i,n+=1;e>n&&(o=t.charAt(n++),u+=o,r!==o||l);)l=i?!l&&"\\"===o:!1;return u},a.Alias=i=function J(t){return this instanceof J?void(this.alias=t):new J(t)},i.get_entry=function(t,n){if(n&&t&&t[h](n)){for(var e=t[n];e instanceof i&&t[h](e.alias);)n=e.alias,e=t[n];return e}return!1},a.Tok=u=function Q(t,n,e,r){var i=this;return i instanceof Q?(i.type=t,i.input=n,i.output=e,i.value=r||null,i.priority=1e3,i.parity=0,i.arity=0,i.associativity=S,i.fixity=x,i.parenthesize=!1,void(i.revert=!1)):new Q(t,n,e,r)},u.render=function(t){return t instanceof u?t.render():t},u[f]={constructor:u,type:null,input:null,output:null,value:null,priority:1e3,parity:0,arity:0,associativity:S,fixity:x,parenthesize:!1,revert:!1,dispose:function(){var t=this;return t.type=null,t.input=null,t.output=null,t.value=null,t.priority=null,t.parity=null,t.arity=null,t.associativity=null,t.fixity=null,t.parenthesize=null,t.revert=null,t},setType:function(t){return this.type=t,this},setParenthesize:function(t){return this.parenthesize=!!t,this},setReverse:function(t){return this.revert=!!t,this},render:function(t){var n,r=this,i=r.output,u=r.paren,l=u?a.LPAREN:"",o=u?a.RPAREN:"";return n=i instanceof e?i.render(t):i,l+n+o},node:function(t,n){return r(this.type,this,t?t:null,n)},toString:function(){return String(this.output)}},a.Op=l=function W(t,e,r,i,l,o,s,a){var c=this;return c instanceof W?(c.parts=[].concat(t),c.type=t&&t.push&&t.pop?q:U,u.call(c,c.type,c.parts[0],o),c.fixity=e||A,c.associativity=r||S,c.priority=i||1e3,c.arity=l||0,c.otype=s,c.ofixity=n!==a?a:c.fixity,c.parenthesize=!1,void(c.revert=!1)):new W(t,e,r,i,l,o,s,a)},l[f]=d(u[f]),l[f].otype=null,l[f].ofixity=null,l[f].parts=null,l[f].render=function(t){t=t||[];var n,r=this,i=r.otype,l=r.output,o=r.parenthesize,s=o?a.LPAREN:"",c=o?a.RPAREN:"",f=a.COMMA,h=r.ofixity,p=t.length;return j===i&&p&&(i=t[0].type),n=l instanceof e?s+l.render(t)+c:x===h?s+t.join(l)+c:I===h?s+t.join(f)+c+l:l+s+t.join(f)+c,u(i,n,n)},l[f].node=function(t,n){t=t||[];var e,i=this,u=i.otype;return i.revert&&t.reverse(),j===u&&t.length&&(u=t[0].type),e=r(u,i,t,n),q===i.type&&arguments.length>2&&(e.parts=i.parts.slice(1),e.op_index=arguments[2],e.next=function(t){var n=0===this.parts.indexOf(t.input);return n&&(this.parts=this.parts.slice(1)),n},e.complete=function(){return!this.parts.length}),e},a.PolyMorph=o=function tn(t){var n=this;return n instanceof tn?(l.call(n),n.type=Y,void(n.morphes=(t||[]).map(tn.condition))):new tn(t)},o.condition=function(t){return["function"==typeof t[0]?t[0]:e.compile(e.multisplit(t[0],{"${POS}":0,"${TOKS}":1,"${OPS}":2,"${TOK}":3,"${OP}":4,"${PREV_IS_OP}":5,"${CUR_TYPE}":6,"${XPRESION}":7}),!0),t[1]]},o[f]=d(l[f]),o[f].morphes=null,o[f].morph=function(t){var n,e=this.morphes,r=e.length,i=0,u=e[0][1],l=!1;for(t.length<8&&(t.push(t[1].length?t[1][0]:!1),t.push(t[2].length?t[2][0]:!1),t.push(t[4]?t[4].pos+1===t[0]:!1),t.push(t[3]?t[3].type:t[4]?t[4].type:0),t.push(a));r>i;){if(n=e[i++],!0===n[0](t)){n=n[1],l=!0;break}n[1].priority>=u.priority&&(u=n[1])}for(l||(n=u);Y===n.type;)n=n.morph(t);return n},a.Func=s=function nn(t,n,e,r,i,u){var o=this;return o instanceof nn?(l.call(o,t,A,i||N,r,1,n,e,u||A),void(o.type=B)):new nn(t,n,e,r,i,u)},s[f]=d(l[f]),a[f]={constructor:a,source:null,variables:null,RE:null,Reserved:null,BLOCKS:null,OPERATORS:null,FUNCTIONS:null,Fn:null,_cnt:0,_cache:null,_symbol_table:null,_evaluator_str:null,_evaluator:null,dummy_evaluator:null,dispose:function(){var t=this;return t.RE=null,t.Reserved=null,t[b]=null,t[O]=null,t[T]=null,t.Fn=null,t.dummy_evaluator=null,t.source=null,t.variables=null,t._cnt=null,t._symbol_table=null,t._cache=null,t._evaluator_str=null,t._evaluator=null,t},setup:function(){var t=this;return t.RE=a.RE,t.Reserved=a.Reserved,t[b]=a[b],t[O]=a[O],t[T]=a[T],t.Fn=a.Fn,t.dummy_evaluator=R,t},compile:function(t){var n=r.DFT(t,a.render_action,!0);return[n,v("Var,Fn,Cache",'"use strict"; return '+n+";")]},parse:function(t){var n,e,r,u,l,o,s,c,f,p,d,v,y,$,g,m=this,R=a,O=(R.Tok,i.get_entry),T=R.reduce,E=m.RE,P=m[b],S=!E[h]("t_var"),F=0;for(arguments.length?m.source=t:t=m.source,n=t.length,m._cnt=0,m._symbol_table={},m._cache={},m.variables={},c=[],f=[],p=[],d=0,l=0;n>l;)if(r=t.charAt(l),(y=O(P,r))&&(u=y.parse(t,l,n,r),!1!==u&&(l+=u.length,$=y[h]("rest")?y.rest(t,l,n)||"":"",l+=$.length,s=m.t_block(u,y.type,$),!1!==s)))++d,c.unshift(s.node(null,d));else if(e=t.slice(l),o=e.match(E.t_spc))l+=o[0].length;else if((o=e.match(E.t_num))&&(s=m.t_liter(o[1],V),!1!==s))++d,c.unshift(s.node(null,d)),l+=o[0].length;else{if(o=e.match(E.t_ident)){if(s=m.t_liter(o[1],C),!1!==s){++d,c.unshift(s.node(null,d)),l+=o[0].length;continue}if(s=m.t_op(o[1]),!1!==s){++d,T(c,f,p,s,d),l+=o[0].length;continue}if(S&&(s=m.t_var(o[1]),!1!==s)){++d,c.unshift(s.node(null,d)),l+=o[0].length;continue}}if(o=e.match(E.t_special)){for(u=o[1],s=!1;u.length>0&&(s=m.t_op(u),!1===s);)u=u.slice(0,-1);if(!1!==s){++d,T(c,f,p,s,d),l+=u.length;continue}}if(S||!(o=e.match(E.t_var))||(s=m.t_var(o[1]),!1===s)){if(o=e.match(E.t_nonspc)){if(s=m.t_liter(o[1],M),!1!==s){++d,c.unshift(s.node(null,d)),l+=o[0].length;continue}if(s=m.t_op(o[1]),!1!==s){++d,T(c,f,p,s,d),l+=o[0].length;continue}s=m.t_tok(o[1]),++d,c.unshift(s.node(null,d)),l+=o[0].length}}else++d,c.unshift(s.node(null,d)),l+=o[0].length}if(F=0,T(c,f,p),(1!==c.length||f.length>0)&&(F=1,g="Parse Error, Mismatched Parentheses or Operators"),!F)try{v=m.compile(c[0])}catch(e){F=1,g="Compilation Error, "+e.message}return p=null,f=null,c=null,m._symbol_table=null,F?(v=null,m.variables=[],m._cnt=0,m._cache={},m._evaluator_str="",m._evaluator=m.dummy_evaluator,console.error("Xpresion Error: "+g+" at "+t)):(m.variables=_(m.variables),m._evaluator_str=v[0],m._evaluator=v[1]),m},evaluator:function(t){return arguments.length?(t&&t.call&&(this._evaluator=t),this):this._evaluator},evaluate:function(t,n){return 1>arguments.length&&(t={}),2>arguments.length&&(n=this.Fn),this._evaluator(t,n,this._cache)},debug:function(t){var n=this,e=["Expression: "+n.source,"Variables : ["+n.variables.join(",")+"]","Evaluator : "+n._evaluator_str];return arguments.length&&(e.push("Data      : "+p(t,null,4)),e.push("Result    : "+p(n.evaluate(t)))),e.join("\n")},toString:function(){return"[Xpresion source]: "+this.source},t_liter:function(t,n){return V===n?u(V,t,t):i.get_entry(this.Reserved,t.toLowerCase())},t_block:function(t,n,e){if(z===n)return u(z,t,t);if(D===n){e=e||"";var r,i,l="re_"+t+e;return this._symbol_table[h](l)?r=this._symbol_table[l]:(r="re_"+ ++this._cnt,i=t.slice(1,-1),this._cache[r]=y(i,e),this._symbol_table[l]=r),u(D,t,"Cache."+r)}if(X===n){e=(e||"").slice(1,-1);var r,i,l="dt_"+t+e;return this._symbol_table[h](l)?r=this._symbol_table[l]:(r="dt_"+ ++this._cnt,i=t.slice(1,-1),this._cache[r]=$(i,e),this._symbol_table[l]=r),u(X,t,"Cache."+r)}return!1},t_var:function(t){return this.variables[h](t)||(this.variables[t]=t),u(k,t,'Var["'+t.split(".").join('"]["')+'"]')},t_op:function(t){var n=!1;return n=i.get_entry(this[T],t),!1===n&&(n=i.get_entry(this[O],t)),n},t_tok:function(t){return u(w,t,t)}},a.defRE=function(t,n){if("object"==typeof t){n=n||a.RE;for(var e in t)t[h](e)&&(n[e]=t[e])}return n},a.defBlock=function(t,n){if("object"==typeof t){n=n||a[b];for(var e in t)t[h](e)&&(n[e]=t[e])}return n},a.defReserved=function(t,n){if("object"==typeof t){n=n||a.Reserved;for(var e in t)t[h](e)&&(n[e]=t[e])}return n},a.defOp=function(t,n){if("object"==typeof t){n=n||a[O];for(var e in t)t[h](e)&&(n[e]=t[e])}return n},a.defFunc=function(t,n){if("object"==typeof t){n=n||a[T];for(var e in t)t[h](e)&&(n[e]=t[e])}return n},a.defRuntimeFunc=function(t,n){if("object"==typeof t){n=n||a.Fn;for(var e in t)t[h](e)&&(n[e]=t[e])}return n},a.init=function(){E||(a[O]={"(":l(["(",")"],I,N,1,1,e("$0"),j),")":l(")"),"[":l(["[","]"],I,N,2,1,e("[$0]"),K),"]":l("]"),",":l(",",x,F,3,2,e("$0,$1"),w),"?":l(["?",":"],x,F,100,3,e("($0?$1:$2)"),L),":":l(":"),"!":l("!",A,N,10,1,e("!($0)"),L),"~":l("~",A,N,10,1,e("~($0)"),V),"^":l("^",x,N,11,2,e("Math.pow($0,$1)"),V,A),"*":l("*",x,F,20,2,e("($0*$1)"),V),"/":l("/",x,F,20,2,e("($0/$1)"),V),"%":l("&",x,F,20,2,e("($0%$1)"),V),"+":o([["${TOK} && !${PREV_IS_OP} && (${CUR_TYPE}==${XPRESION}.T_ARY)",l("+",x,F,25,2,e("[].concat($0,$1)"),K)],["${TOK} && !${PREV_IS_OP} && (${CUR_TYPE}==${XPRESION}.T_STR)",l("+",x,F,25,2,e("($0+String($1))"),z)],["${TOK} && !${PREV_IS_OP}",l("+",x,F,25,2,e("($0+$1)"),V)],["!${TOK} || ${PREV_IS_OP}",l("+",A,N,4,1,e("$0"),V)]]),"-":o([["${TOK} && !${PREV_IS_OP}",l("-",x,F,25,2,e("($0-$1)"),V)],["!${TOK} || ${PREV_IS_OP}",l("-",A,N,4,1,e("(-$0)"),V)]]),">>":l(">>",x,F,30,2,e("($0>>$1)"),V),"<<":l("<<",x,F,30,2,e("($0<<$1)"),V),">":l(">",x,F,35,2,e("($0>$1)"),L),"<":l("<",x,F,35,2,e("($0<$1)"),L),">=":l(">=",x,F,35,2,e("($0>=$1)"),L),"<=":l("<=",x,F,35,2,e("($0<=$1)"),L),"==":o([["${CUR_TYPE}==${XPRESION}.T_ARY",l("==",x,F,40,2,e("Fn.ary_eq($0,$1)"),L)],["true",l("==",x,F,40,2,e("($0==$1)"),L)]]),"!=":l("!=",x,F,40,2,e("($0!=$1)"),L),matches:l("matches",x,P,40,2,e("$0.test($1)"),L),"in":l("in",x,P,40,2,e("(-1<$1.indexOf($0))"),L),has:l("has",x,P,40,2,e("(-1<$0.indexOf($1))"),L),"&":l("&",x,F,45,2,e("($0&$1)"),V),"|":l("|",x,F,46,2,e("($0|$1)"),V),"&&":l("&&",x,F,47,2,e("($0&&$1)"),L),"||":l("||",x,F,48,2,e("($0||$1)"),L),or:i("||"),and:i("&&")},a[T]={min:s("min",e("Math.min($0)"),V,5),max:s("max",e("Math.max($0)"),V,5),pow:s("pow",e("Math.pow($0)"),V,5),sqrt:s("sqrt",e("Math.sqrt($0)"),V,5),len:s("len",e("Fn.len($0)"),V,5),"int":s("int",e("Fn.toint($0)"),V,5),str:s("str",e("Fn.tostr($0)"),z,5),iif:s("iif",e("Fn.iif($0)"),L,5),clamp:s("clamp",e("Fn.clamp($0)"),V,5),sum:s("sum",e("Fn.sum($0)"),V,5),avg:s("avg",e("Fn.avg($0)"),V,5)},a.Fn={toint:function(t,n){return parseInt(t,n||10)},tostr:function(t){return String(t)},iif:function(t,n,e){return t?n:e},clamp:function(t,n,e){return n>e?t>n?n:e>t?e:t:t>e?e:n>t?n:t},len:function(t){return t?t.substr||t.push?t.length:Object===t.constructor?_(t).length:1:0},sum:function(){var t,n,e=arguments,r=0;if(e[0]&&Array===e[0].constructor&&(e=e[0]),n=e.length,n>0)for(t=0;n>t;t++)r+=e[t];return r},avg:function(){var t,n,e=arguments,r=0;if(e[0]&&Array===e[0].constructor&&(e=e[0]),n=e.length,n>0){for(t=0;n>t;t++)r+=e[t];r/=n}return r},ary_eq:function(t,n){var e,r=t.length,i=r===n.length;if(i)for(e=0;r>e;e++)if(t[e]!=n[e])return!1;return i},match:function(t,n){return n.test(t)},contains:function(t,n){return-1<t.indexOf(n)}},a.RE={t_spc:/^(\s+)/,t_nonspc:/^(\S+)/,t_special:/^([*.\-+\\\/\^\$\(\)\[\]|?<:>&~%!#@=_,;{}]+)/,t_num:/^(\d+(\.\d+)?)/,t_ident:/^([a-zA-Z_][a-zA-Z0-9_]*)\b/,t_var:/^\$([a-zA-Z0-9_][a-zA-Z0-9_.]*)\b/},a[b]={"'":{type:z,parse:function(t,n,e,r){return a.parse_delimited_block(t,n,e,r,!0)}},'"':i("'"),"`":{type:D,parse:function(t,n,e,r){return a.parse_delimited_block(t,n,e,r,!0)},rest:function(t,n,e){for(var r,i="",u=!1,l=!1,o=0,s=n+o,a=!0;e>s&&a;)r=t.charAt(s++),o+=1,"i"!==r||u||(i+="i",u=!0),"g"!==r||l||(i+="g",l=!0),(o>=2||!u&&!l)&&(a=!1);return i}},"#":{type:X,parse:function(t,n,e,r){return a.parse_delimited_block(t,n,e,r,!0)},rest:function(t,n,e){var r='"Y-m-d"',i=e>n?t.charAt(n):"";return('"'===i||"'"===i)&&(r=a.parse_delimited_block(t,n,e,i,!0)),r}}},a.Reserved={"null":u(C,"null","null"),"false":u(L,"false","false"),"true":u(L,"true","true"),infinity:u(V,"Infinity","Infinity"),nan:u(V,"NaN","NaN"),none:i("null"),inf:i("inf")},E=!0)},a.init(),a});